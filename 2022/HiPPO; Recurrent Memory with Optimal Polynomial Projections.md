# HiPPO: Recurrent Memory with Optimal Polynomial Projections

## 論文について (掲載ジャーナルなど)
- [Gu, Albert, et al. "Hippo: Recurrent memory with optimal polynomial projections." Advances in Neural Information Processing Systems 33 (2020): 1474-1487.](https://proceedings.neurips.cc/paper/2020/file/102f0bb6efb3a6128a3c750dd16729be-Paper.pdf)

## 概要
- 逐次的に入ってくる時系列データから学習することを考える
    - 中心的な課題は、「多くのデータが処理されるにつれて、どんどん増えてくる履歴を段階的に表現していくこと」である

- 本論文では、多項式関数の基底へ射影することにより、連続信号や離散時系列を**オンライン**で圧縮する一般的なフレームワーク（HiPPO)を提案
    - 過去の各時刻ステップの重要度を指定する尺度が与えられると、HiPPOは自然なオンライン関数近似問題に対する最適解を生成する

- 提案する新しい記憶更新機構（HiPPO-Legs）は以下の理論的な利点がある
    - 時間スケールに対するロバスト性
        - DNNやLSTMは同じ時間スケールのデータでないと精度がでないが、HiPPOは異なる時間スケールのデータでも性能が落ちない

    - 高速な記憶の更新
    - 有界なGradients


## 問題設定と解決したこと
- 逐次的に入ってくるデータのモデリングと学習は、以下のタスクの基礎となり、基本的な問題
    - 言語モデリング、音声認識、映像処理、強化学習

- 長期的かつ複雑な時間依存性をモデル化する上で、「記憶＝以前の時間ステップからの情報を保存し、取り込むこと」が重要
    - より多くのデータが逐次的に入ってきたときを考えると、記憶はオンラインで更新される必要がある
    - 限られたストレージを用いて、蓄積されるhistory全体の表現を学習しなければならない

- 上記の問題に対する既存の手法として、RNNがあげられる
    - どんな方法？
        - 多くの情報を取り込みながら時間と共に変化していく状態をモデル化するアプローチ

    - RNNの課題は？
        - メモリバク食い
        - gradientsの消失

    - RNNの課題を克服するヒューリスティックな方法として、以下が挙げられている
        - LSTM、GRU、フーリエ再帰ユニット、ルジャンドルメモリユニット（LMU）

    - それでもまだ残る課題
        - gradients の消失
            - 数万ステップもあるような、とても長いデータだと記憶が保持できない
        - シーケンス長や時間スケールに対する事前に仮定を置いている
            - シーケンス長、時間スケールが異なるデータには適用できない
        - 「長期依存性をどの程度うまくとらえることができるか」についての理論的保証が無い

- 本論文で解決したこと
    1.  記憶に扱う方法の理論的な定式化
        -   既存手法の統一的な見解を示した

    2.  時間スケールへの事前の仮定なく、任意のシーケンス長のデータを扱うことができる手法の提案
    3.  記憶を扱うことに対する厳密な理論的証明


## 何をどう使ったのか
- 提案手法 **HiPPO** (high-order polynomial projection operators) 
    - 任意の関数を与えられた尺度に関して直交多項式空間に射影する演算子
        - 尺度：過去における各時刻のデータの重要度
- 入力関数$f(t) : \mathbb{R}_+ \rightarrow \mathbb{R}$が与えられたとき、逐次的に入ってくる入力を理解し、将来の予測を行うために、時刻$t\ge 0$ ごとに累積history $f_{\le t}:= f(x)|_{x\le t}$ を操作することが必要
    - 関数空間は非常に大きいので、historyを完全に記憶することができない→圧縮する
    - historyを有界次元の部分空間に射影する
    - しかも、圧縮したhistory の表現をオンラインで更新していく
- HiPPOの数学面の構成要素
    1.  測度に関する関数近似
        -   近似の質を評価するために、関数空間における距離を定義する必要がある
        -   $[0,\infty)$上の確率測度を指定することで、（関数と関数の内積を定義し、）2乗可積分関数の空間＝ヒルベルト空間を用意する
            -   内積から誘導されるノルムも自然に定まる

    2.  多項式基底展開
        -   関数空間の任意の$N$次元部分空間$\mathcal{g}$は、近似のための適切な候補
        -   パラメータ$N$は近似の次数＝圧縮の大きさに相当し、投影されたhistoryは$\mathcal{g}$の任意の基底における展開の$N$個の係数で表すことができる
        -   本論文では、$\mathcal{g}$が$N$未満の次数の多項式の集合であるように、自然基底として多項式を用いる

    3.  オンライン近似
        -   時間$t$ごとに$f_{\le t}$を近似することに関心があるので、測度も時間によって変化させる
            -   すべての$t$について、$\mu^{(t)}$を$(-\infty,t]$上の測度とする
                -   なんで$(-\infty, t]$？→$f_{\le t}$は時間$t$までしか定義されないので

        -   $\|f_{\le t}-g^{(t)} \|_{L_2 (\mu^{(t)})}$を最小化する$g^{(t)}\in\mathcal{G}$を求める
            -   直感的な解釈
                -   測度$\mu$が入力されるデータのそれぞれの部分の重要度をコントロール
                -   基底は許容される近似を定義する

        -   解きたい課題としては、
            -   $\mu^{(t)}$が与えられたときにいかにして閉じられた形で、（与えられた関数と近似する関数の距離を最小化する）最適化問題をとくか
            -   $t\rightarrow \infty$のときに、基底の係数をオンラインで維持するか

### HiPPOの定式化

-   **[定義 1]**
    -   時間 $t$ に伴って変化する $(-\infty, t]$ 上の測度族を $\mu^{(t)}$ 、多項式関数の$N$次元部分空間を $\mathcal{g}$ 、連続関数  $f:\mathbb{R}_{\ge0}\rightarrow \mathbb{R}$ とする。このとき、*HiPPO* は時間$t$ごとに射影演算子 $\text{proj}_t$ と係数抽出演算子 $\text{coef}_t$ を定義し、それらは以下の性質を持つ。
        1.   $\text{proj}_t$ は、関数 $f$ を時間 $t$ までに制限した関数 $f_{\le t}:=f(x)|_{x\le t}$ をとり、$f_{\le t}$ を近似誤差 $\| f_{\le t} - g^{(t)} \|_{L_2 (\mu^{(t)})}$ が最小になる多項式 $g^{(t)}\in \mathcal{g}$ に写像する。
        2.   $\text{coef}_t: \mathcal{g}\rightarrow \mathbb{R}^N$ は、多項式関数 $g^{(t)}$ を測度 $\mu^{(t)}$ に関して定義される直交多項式の基底の 係数 $c(t)\in \mathbb{R}^N$ に写像する。
    -   演算子の合成 $\text{coef}\circ \text{proj}$ を*hippo*とよび、この演算子は 関数 $f: \mathbb{R}_{\ge0}\rightarrow \mathbb{R}$ を最適な射影係数 $c:\mathbb{R}_{\ge0}\rightarrow \mathbb{R}^N$ に写像する。すなわち、$(\text{hippo}(f))(t)=\text{coef}_t(\text{proj}_t (f))$ である。
-   ![HiPPO_Fig_1](picture/HiPPO_Fig_1.png)
    -   各時間 $t$ について最適射影 $\text{proj}_t(f)$ は内積によってよく定義されるが、素朴に計算するのは困難
    -   係数関数 $c(t)=\text{coef}_t(\text{proj}_t(f))$ は、ある$A(t)\in \mathbb{R}^{N\times N}$と$B(t)\in \mathbb{R}^{N\times 1}$に対して $\frac{d}{dt}c(t)=A(t)c(t)+B(t)f(t)$ を満たすODE（常微分方程式）形式であることを付録Dに記載している。
    -   このODEを解く（離散的な漸化式を解く）ことにより、$c(t)$ をオンラインで簡単に求めることができる
        -   逆順に考えるとなんで時間に伴って変化する測度と多項式近似を使ってるのかわかりよい
            -   時間に伴って変化する測度は近似の品質を操作したいから、直近の過去を重要視したいという要望に答えるため
            -   測度に関する内積を定義→ヒルベルト空間を考えるのは線型結合の係数の導出が簡単だから
            -   **(4)の漸化式の形にしたいから、多項式関数を使った近似を選択している**
                -   付録C.3の式(20)を見るとわかりやすい。
                -   （$n$次の多項式）×（重み関数=時間と共に変化する測度）の形の積分の微分
                    →$n-1$ 次の多項式 + $N-1$次の多項式の形になる
                    →漸化式の形になる
                    -   [注意]まだふわっとした理解になってるぞ！
    -   HiPPO 演算子は離散化すると実数列を受け取り、$N$次元ベクトルを返す

### 時間発展する測度と（それと対応する）HiPPO ODEsの例

-   様々な測度の例

    -   *The translated Legendre (LegT) measures*

        -   $[t-\theta, t]$ に一様な重みを割り当てる測度
            -   $\theta$ はスライディングウィンドウの長さ（要約される history の長さ）を表すハイパーパラメータ
            -   ※なんで*translated*なのか？
                -   ルジャンドル多項式は$[-1,1]$の範囲で定義される関数。これを$[t-\theta,t]$の範囲に変換しているということ
        -   $$
            \text{LegT}: \mu^{(t)}=\frac{1}{\theta}\mathbb{1}_{[t-\theta, t]}(x)
            $$

            

    -   *The translated Laguerre (LagT) measures*

        -   $(-\infty, t]$に指数関数的に減衰する重みを割り当てる測度

            -   最近の history を重視する

        -   $$
            \text{LagT}: \mu^{(t)}
            &=& e^{-(t-x)}\mathbb{1}_{(-\infty, t]}(x) \\
            &=& \begin{cases}
            e^{x-t}& \text{if}\quad x\leq t \\
            0& \text{if}\quad x>t
            \end{cases}
            $$

-   **[定理 1]**

    -   LegTとLagTについて、定義1をみたす HiPPO 演算子は、$\frac{d}{dt}c(t)=-Ac(t)+B(t)$ where $A \in \mathbb{R}^{N\times N}, B\in\mathbb{R}^{N\times 1}$ の形の線形時不変 (linear time-invariant : LTI)常微分方程式 (ODEs) で与えられる。


$$
\text{LegT}:&\\
A_{nk} &= \frac{1}{\theta} \begin{cases}
(-1)^{n-k}(2n+1) & \text{if}\quad n\geq k \\
2n+1 & \text{if}\quad n\leq k
\end{cases}\ , \quad
B_n = \frac{1}{\theta}(2n+1)(-1)^n
$$

$$
\text{LagT:} & \\
A_{nk} &= \begin{cases}
1 & \text{if}\quad n\geq k \\
0 & \text{if}\quad n\leq k
\end{cases}\ , \quad
B_n = 1
$$

-   [TODO]
    -   ルジャンドル多項式の性質についてまとめる
    -   P.27 D.1 Coefficient Dynamics の数式を追う
        -   HiPPO/S4解説の32~41ページも参考になるやで


## 主張の有効性の検証方法
- 

## 批評
- 

## 次に読むべき論文
- 
